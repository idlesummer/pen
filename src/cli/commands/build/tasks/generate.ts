import { mkdir, writeFile } from 'fs/promises'
import { join } from 'path'

import { duration, type Task } from '@idlesummer/tasker'
import { PACKAGE_NAME } from '@/core/constants'
import { buildComponentMap } from '@/core/route-builder'
import type { BuildContext } from '../types'

export const generateTasks: Task<BuildContext>[] = [
  {
    name: 'Writing manifest.ts',
    onSuccess: (_, dur) => `Saved manifest.ts (${duration(dur)})`,
    run: async (ctx) => {
      const genDir = join(ctx.outDir, 'generated')
      const manifestPath = join(genDir, 'manifest.ts')
      await mkdir(genDir, { recursive: true })

      const code = [
        `// Auto-generated by ${PACKAGE_NAME}`,
        '// Do not manually edit this file',
        '',
        `import { RouteManifest } from '${PACKAGE_NAME}'`,
        '',
        `export const manifest: RouteManifest = ${JSON.stringify(ctx.manifest!, null, 2)} as const`,
        '',
      ].join('\n')

      await writeFile(manifestPath, code, 'utf-8')
    },
  },
  {
    name: 'Writing components.ts',
    onSuccess: (_, dur) => `Saved components.ts (${duration(dur)})`,
    run: async (ctx) => {
      const genDir = join(ctx.outDir, 'generated')
      const componentsPath = join(genDir, 'components.ts')
      await mkdir(genDir, { recursive: true })

      const componentMap = buildComponentMap(ctx.manifest!, ctx.outDir)
      const entries = Object.entries(componentMap).sort(([a], [b]) => a.localeCompare(b))

      const imports = entries
        .map(([_, importPath], i) => `import Component${i} from '${importPath}'`)
        .join('\n')

      const exports = entries
        .map(([absPath], i) => `  '${absPath.replace(/\\/g, '\\\\')}': Component${i},`)
        .join('\n')

      const code = [
        `// Auto-generated by ${PACKAGE_NAME}`,
        '// Do not manually edit this file',
        '',
        `import { ComponentMap } from '${PACKAGE_NAME}'`,
        '',
        imports,
        '',
        'export const components: ComponentMap = {',
        exports,
        '} as const',
        '',
      ].join('\n')

      await writeFile(componentsPath, code, 'utf-8')
    },
  },
  {
    name: 'Writing entry.ts',
    onSuccess: (_, dur) => `Saved entry.ts (${duration(dur)})`,
    run: async (ctx) => {
      const genDir = join(ctx.outDir, 'generated')
      const entryPath = join(genDir, 'entry.ts')
      await mkdir(genDir, { recursive: true })

      const code = [
        `// Auto-generated by ${PACKAGE_NAME}`,
        '// Do not manually edit this file',
        '',
        'import { createElement } from \'react\'',
        'import { render } from \'ink\'',
        `import { App } from '${PACKAGE_NAME}'`,
        '',
        'import { manifest } from \'./manifest\'',
        'import { components } from \'./components\'',
        '',
        'export async function run(initialUrl: string) {',
        '  const element = createElement(App, { initialUrl, manifest, components })',
        '  const { waitUntilExit } = render(element)',
        '  await waitUntilExit()',
        '}',
        '',
      ].join('\n')

      await writeFile(entryPath, code, 'utf-8')
    },
  },
]
