import type { Task } from '@idlesummer/tasker'
import type { BuildContext } from '../types'
import { mkdir, writeFile } from 'fs/promises'
import { join } from 'path'
import { duration } from '@idlesummer/tasker'
import { PACKAGE_NAME } from '@/core/constants'

// ===== Main Task =====

export const writeElementTreeFile: Task<BuildContext> = {
  name: 'Writing element-tree.json',
  onSuccess: (_, dur) => `Saved element-tree.json (${duration(dur)})`,
  run: async (ctx) => {
    const genDir = join(ctx.outDir, 'generated')
    const elementTreePath = join(genDir, 'element-tree.json')

    const content = {
      _comment: `Auto-generated by ${PACKAGE_NAME} - This file is for documentation/debugging only`,
      elementTrees: ctx.elementTrees!,
    }

    await mkdir(genDir, { recursive: true })
    await writeFile(elementTreePath, JSON.stringify(content, null, 2), 'utf-8')
  },
}
