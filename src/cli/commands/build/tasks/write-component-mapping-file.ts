import type { Task } from '@idlesummer/tasker'
import type { BuildContext } from '../types'
import { mkdir, writeFile } from 'fs/promises'
import { join } from 'path'
import { duration } from '@idlesummer/tasker'
import { PACKAGE_NAME } from '@/core/constants'

export const writeComponentMapFile: Task<BuildContext> = {
  name: 'Writing components.ts',
  onSuccess: (_, dur) => `Saved components.ts (${duration(dur)})`,
  run: async (ctx) => {
    const genDir = join(ctx.outDir, 'generated')
    const componentsPath = join(genDir, 'components.ts')

    const imports = (ctx.componentMap)
    const lines = [
      `// Auto-generated by ${PACKAGE_NAME}`,
      '// Do not manually edit this file',
      '// NOTE: This file maps component indices to their import paths for reference.',
      '',
      '// Component Mapping:',
    ]

    for (let i = 0; i < imports.length; i++) {
      lines.push(`// Component${i} -> ${imports[i]}`)
    }

    lines.push('')

    const code = lines.join('\n')

    await mkdir(genDir, { recursive: true })
    await writeFile(componentsPath, code, 'utf-8')
  },
}
