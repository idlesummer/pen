import type { Task } from '@idlesummer/tasker'
import type { BuildContext } from '../types'
import type { ElementTree } from '@/core/route-builder'
import { ComponentRef } from '@/core/route-builder'
import { mkdir, writeFile } from 'fs/promises'
import { join } from 'path'
import { duration } from '@idlesummer/tasker'
import { PACKAGE_NAME } from '@/core/constants'

export const writeRoutesFile: Task<BuildContext> = {
  name: 'Writing routes.ts',
  onSuccess: (_, dur) => `Saved routes.ts (${duration(dur)})`,
  run: async (ctx) => {
    const genDir = join(ctx.outDir, 'generated')
    const routesPath = join(genDir, 'routes.ts')
    const componentImports = ctx.componentImports!
    const elementTrees = ctx.elementTrees!

    // Generate component imports
    const importStatements = componentImports.imports
      .map((importPath, i) => `import Component${i} from '${importPath}'`)
      .join('\n')

    // Generate pre-built route elements from element trees
    const routeElements: string[] = []
    for (const [url, tree] of Object.entries(elementTrees)) {
      const elementCode = serialize(tree)
      routeElements.push(`  '${url}': ${elementCode},`)
    }

    const code = [
      `// Auto-generated by ${PACKAGE_NAME}`,
      '// Do not manually edit this file',
      '',
      `import type { CompiledRoutes } from '${PACKAGE_NAME}'`,
      'import { createElement } from \'react\'',
      '',
      importStatements,
      '',
      '// Compiled route elements generated at build time',
      'export const routes: CompiledRoutes = {',
      routeElements.join('\n'),
      '} as const',
      '',
    ].join('\n')

    await mkdir(genDir, { recursive: true })
    await writeFile(routesPath, code, 'utf-8')
  },
}

/** Serialize ElementTree to createElement string. */
function serialize(tree: ElementTree): string {
  const props = Object.entries(tree.props)
    .map(([key, value]) => {
      // Component references are not quoted
      if (value instanceof ComponentRef) {
        return `${key}: ${value.name}`
      }
      // Everything else is JSON stringified (strings get quotes, etc.)
      return `${key}: ${JSON.stringify(value)}`
    })
    .join(', ')

  return tree.children
    ? `createElement(${tree.component}, { ${props} }, ${serialize(tree.children)})`
    : `createElement(${tree.component}, { ${props} })`
}
