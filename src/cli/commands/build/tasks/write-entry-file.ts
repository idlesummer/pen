import type { Task } from '@idlesummer/tasker'
import type { BuildContext } from '../types'
import { mkdir, writeFile } from 'fs/promises'
import { join } from 'path'
import { duration } from '@idlesummer/tasker'
import { PACKAGE_NAME } from '@/pen/constants'

const filename = 'entry.ts'

export const writeEntryFile: Task<BuildContext> = {
  name: `Writing ${filename}`,
  onSuccess: (_, dur) => `Saved ${filename} (${duration(dur)})`,
  run: async (ctx) => {
    const genDir = join(ctx.outDir, 'generated')
    const outDir = join(genDir, filename)
    const code = [
      `// Auto-generated by ${PACKAGE_NAME}`,
      '// Do not manually edit this file',
      '',
      'import { createElement } from \'react\'',
      'import { render } from \'ink\'',
      `import { App } from '${PACKAGE_NAME}'`,
      'import { compiledRoutes as routes } from \'./compiled-routes\'',
      '',
      'export async function run(initialUrl: string) {',
      '  const element = createElement(App, { initialUrl, routes })',
      '  const { waitUntilExit } = render(element)',
      '  await waitUntilExit()',
      '}',
      '',
    ].join('\n')

    await mkdir(genDir, { recursive: true })
    await writeFile(outDir, code, 'utf-8')
  },
}
