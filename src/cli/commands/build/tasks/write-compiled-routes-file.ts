import type { Task } from '@idlesummer/tasker'
import type { SerializedComponentTree } from '@/pen/compiler'
import type { BuildContext } from '../types'
import { mkdir, writeFile } from 'fs/promises'
import { join } from 'path'
import { duration } from '@idlesummer/tasker'
import { PACKAGE_NAME } from '@/pen/constants'

const filename = 'compiled-routes.ts'

export const writeCompiledRoutesFile: Task<BuildContext> = {
  name: `Writing ${filename}`,
  onSuccess: (_, dur) => `Saved ${filename} (${duration(dur)})`,
  run: async (ctx) => {
    const genDir = join(ctx.outDir, 'generated')
    const outDir = join(genDir, filename)
    const serializedRoutes = ctx.serializedRoutes!
    const componentIdMap = ctx.componentIdMap!

    // Generate component imports
    const importStatements = Object.keys(componentIdMap)
      .map((importPath, i) => `import Component${i} from '${importPath}'`)
      .join('\n')

    // Generate pre-built route components from element trees
    const routeEntries: string[] = []
    for (const [url, tree] of Object.entries(serializedRoutes)) {
      const elementCode = `    ${serialize(tree).replace(/\n/g, '\n    ')}`
      routeEntries.push(`  '${url}':\n${elementCode},`)
    }

    const code = [
      `// Auto-generated by ${PACKAGE_NAME}`,
      '// Do not manually edit this file',
      '',
      `import type { CompiledRoutes } from '${PACKAGE_NAME}'`,
      'import { createElement } from \'react\'',
      '',
      importStatements,
      '',
      '// Compiled route elements generated at build time',
      'export const compiledRoutes: CompiledRoutes = {',
      routeEntries.join('\n'),
      '} as const',
      '',
    ].join('\n')

    await mkdir(genDir, { recursive: true })
    await writeFile(outDir, code, 'utf-8')
  },
}

/** Serializes an SerializedRoutes to React.createElement() code string. */
export function serialize(tree: SerializedComponentTree, indent = 0): string {
  const spaces = '  '.repeat(indent)

  // Props are already pre-serialized (strings have quotes, identifiers don't)
  const props = Object.entries(tree.props)
    .map(([key, value]) => `${key}: ${value}`)
    .join(', ')

  if (!tree.children)
    return `createElement(${tree.component}, { ${props} })`

  const childCode = serialize(tree.children, indent + 1)
  return `createElement(${tree.component}, { ${props} },\n${spaces}  ${childCode}\n${spaces})`
}
